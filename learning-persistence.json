[
  {
    "id": "1.1",
    "category": "infrastructure",
    "description": "Add to_dict() method to AdaptiveLearner for serialization",
    "steps": [
      "TEST: test_adaptive_learner_to_dict_empty - returns dict with expected keys when no cycles",
      "IMPL: Add to_dict() method in adaptive/learning.py returning cycle_history, last_adjustment_time, consecutive_converged_cycles, pid_converged_for_ke, auto_apply_count",
      "TEST: test_adaptive_learner_to_dict_with_cycles - serializes CycleMetrics correctly (overshoot, undershoot, settling_time, oscillations, rise_time)",
      "IMPL: Add _serialize_cycle() helper to convert CycleMetrics to dict",
      "TEST: test_adaptive_learner_to_dict_timestamps - converts datetime to ISO string, handles None",
      "IMPL: Handle last_adjustment_time serialization with isoformat()",
      "VERIFY: pytest tests/test_learning.py -k to_dict -v passes"
    ],
    "passes": true,
    "commitId": "60afb335b4e510bc120692706266f41fa7555f3e"
  },
  {
    "id": "1.2",
    "category": "infrastructure",
    "description": "Add restore_from_dict() method to AdaptiveLearner for in-place restoration",
    "steps": [
      "TEST: test_adaptive_learner_restore_empty - restores empty state without error",
      "IMPL: Add restore_from_dict(data) method that clears _cycle_history and repopulates",
      "TEST: test_adaptive_learner_restore_cycles - restores CycleMetrics from dict list",
      "IMPL: Create CycleMetrics from dict data in restore loop",
      "TEST: test_adaptive_learner_restore_convergence - restores consecutive_converged_cycles, pid_converged_for_ke, auto_apply_count",
      "IMPL: Restore all convergence tracking fields from dict",
      "TEST: test_adaptive_learner_restore_timestamps - parses ISO string to datetime",
      "IMPL: Handle datetime.fromisoformat() for last_adjustment_time",
      "VERIFY: pytest tests/test_learning.py -k restore_from_dict -v passes"
    ],
    "passes": true,
    "commitId": "1576fb3b960587835bdffee9aab7bdbd011f2aca"
  },
  {
    "id": "2.1",
    "category": "refactor",
    "description": "Refactor LearningDataStore to use HA Store helper with zone-keyed storage",
    "steps": [
      "TEST: test_learning_store_init - creates Store with correct key 'adaptive_thermostat_learning'",
      "IMPL: Replace file I/O in __init__ with homeassistant.helpers.storage.Store",
      "TEST: test_learning_store_async_load_empty - returns {'version': 3, 'zones': {}} when no file",
      "IMPL: Add async_load() using self._store.async_load() with default fallback",
      "TEST: test_learning_store_async_load_v2_migration - migrates v2 format to v3 zone-keyed format",
      "IMPL: Add _migrate_v2_to_v3() to convert old flat format to zones dict",
      "TEST: test_learning_store_get_zone_data - returns correct zone dict or None",
      "IMPL: Add get_zone_data(zone_id) returning self._data['zones'].get(zone_id)",
      "VERIFY: pytest tests/test_learning_storage.py -k 'init or load or get_zone' -v passes"
    ],
    "passes": true,
    "commitId": "d8e48665193d11538e697d1c61fd5694d6dd8bfa"
  },
  {
    "id": "2.2",
    "category": "refactor",
    "description": "Add async_save_zone() and schedule_zone_save() to LearningDataStore",
    "steps": [
      "TEST: test_learning_store_async_save_zone - saves zone data with lock protection",
      "IMPL: Add async_save_zone(zone_id, adaptive_data, ke_data) with asyncio.Lock",
      "TEST: test_learning_store_schedule_zone_save - uses async_delay_save with 30s delay",
      "IMPL: Add schedule_zone_save() calling self._store.async_delay_save()",
      "TEST: test_learning_store_concurrent_saves - lock prevents race conditions",
      "IMPL: Ensure _save_lock protects async_save_zone",
      "VERIFY: pytest tests/test_learning_storage.py -k 'save' -v passes"
    ],
    "passes": true,
    "commitId": "564a9139a6b47e7dcbdbb86e426253fce4f65380"
  },
  {
    "id": "3.1",
    "category": "feature",
    "description": "Integrate LearningDataStore singleton in async_setup_platform",
    "steps": [
      "TEST: test_setup_creates_learning_store - first zone creates store in hass.data[DOMAIN]",
      "IMPL: In async_setup_platform (~line 323), create LearningDataStore if not exists, call async_load()",
      "TEST: test_setup_restores_adaptive_learner - calls restore_from_dict when stored data exists",
      "IMPL: After AdaptiveLearner creation, call learning_store.get_zone_data() and restore_from_dict()",
      "TEST: test_setup_stores_ke_data_for_later - zone_data['stored_ke_data'] populated from storage",
      "IMPL: Store ke_learner data in zone_data for async_added_to_hass to use",
      "VERIFY: pytest tests/test_climate.py -k setup -v passes"
    ],
    "passes": true,
    "commitId": "ea3beee0e531df1f662368819b3c4fc9a2b921b4"
  },
  {
    "id": "3.2",
    "category": "feature",
    "description": "Restore KeLearner from storage in async_added_to_hass",
    "steps": [
      "TEST: test_ke_learner_restored_from_storage - uses KeLearner.from_dict when stored_ke_data exists",
      "IMPL: In async_added_to_hass (~line 789), check zone_data['stored_ke_data'] before physics init",
      "TEST: test_ke_learner_falls_back_to_physics - creates new KeLearner when no stored data",
      "IMPL: Keep existing physics-based initialization as fallback",
      "VERIFY: pytest tests/test_climate.py -k ke_learner -v passes"
    ],
    "passes": true,
    "commitId": "5d457ede3d3dfd64022f6fc35a35901c731ff47d"
  },
  {
    "id": "3.3",
    "category": "feature",
    "description": "Save learning data in async_will_remove_from_hass",
    "steps": [
      "TEST: test_removal_saves_learning_data - calls async_save_zone on entity removal",
      "IMPL: In async_will_remove_from_hass, get learning_store and call async_save_zone()",
      "TEST: test_removal_saves_both_learners - saves adaptive_learner.to_dict() and ke_learner.to_dict()",
      "IMPL: Pass both to_dict() results to async_save_zone()",
      "VERIFY: pytest tests/test_climate.py -k 'remove or removal' -v passes"
    ],
    "passes": true,
    "commitId": "aef43c08e89c17d1a1174b3546e89f83d2e195cc"
  },
  {
    "id": "4.1",
    "category": "feature",
    "description": "Add restoration gating to CycleTrackerManager",
    "steps": [
      "TEST: test_cycle_tracker_ignores_updates_before_restoration - no state change when _restoration_complete=False",
      "IMPL: Add _restoration_complete=False to __init__, guard in _on_temperature_update()",
      "TEST: test_cycle_tracker_processes_after_restoration - normal behavior after set_restoration_complete()",
      "IMPL: Add set_restoration_complete() method setting flag to True",
      "VERIFY: pytest tests/test_cycle_tracker.py -k restoration -v passes"
    ],
    "passes": false
  },
  {
    "id": "4.2",
    "category": "feature",
    "description": "Trigger debounced save after cycle finalization",
    "steps": [
      "TEST: test_finalize_cycle_schedules_save - calls schedule_zone_save after adding metrics",
      "IMPL: In _finalize_cycle(), get learning_store from hass.data and call schedule_zone_save()",
      "TEST: test_finalize_cycle_passes_adaptive_data - passes adaptive_learner.to_dict() to save",
      "IMPL: Call self._adaptive_learner.to_dict() for save data",
      "VERIFY: pytest tests/test_cycle_tracker.py -k finalize -v passes"
    ],
    "passes": false
  },
  {
    "id": "5.1",
    "category": "test",
    "description": "Update test_learning_storage.py for new HA Store-based API",
    "steps": [
      "IMPL: Update fixtures to mock homeassistant.helpers.storage.Store",
      "IMPL: Update test_data_saving to use async_save_zone API",
      "IMPL: Update test_data_loading to use async_load and get_zone_data",
      "IMPL: Add test_v2_migration for legacy format migration",
      "VERIFY: pytest tests/test_learning_storage.py -v passes all tests"
    ],
    "passes": false
  },
  {
    "id": "5.2",
    "category": "test",
    "description": "Add integration test for persistence round-trip",
    "steps": [
      "IMPL: Add test_persistence_roundtrip in test_integration_cycle_learning.py",
      "IMPL: Test: create learner, add cycles, save, create new learner, restore, verify cycles match",
      "IMPL: Test: verify KeLearner observations persist and restore correctly",
      "VERIFY: pytest tests/test_integration_cycle_learning.py -k roundtrip -v passes"
    ],
    "passes": false
  },
  {
    "id": "6.1",
    "category": "docs",
    "description": "Update CLAUDE.md with persistence architecture",
    "steps": [
      "IMPL: Add 'Persistence' section under 'Key Technical Details' explaining LearningDataStore",
      "IMPL: Document storage format v3 with zone-keyed structure",
      "IMPL: Add data flow diagram showing startup restoration and shutdown save",
      "VERIFY: Review CLAUDE.md for accuracy and completeness"
    ],
    "passes": false
  }
]
