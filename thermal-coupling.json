[
  {
    "id": "1.1",
    "category": "infrastructure",
    "description": "Add thermal coupling constants to const.py",
    "steps": [
      "IMPL: Add CONF_THERMAL_COUPLING, CONF_FLOORPLAN, CONF_STAIRWELL_ZONES, CONF_SEED_COEFFICIENTS to const.py",
      "IMPL: Add DEFAULT_SEED_COEFFICIENTS dict: {same_floor: 0.15, up: 0.40, down: 0.10, open: 0.60, stairwell_up: 0.45}",
      "IMPL: Add MAX_COUPLING_COMPENSATION dict per heating type: {floor_hydronic: 1.0, radiator: 1.2, convector: 1.5, forced_air: 2.0}",
      "IMPL: Add coupling learner constants: MIN_OBSERVATIONS=3, MAX_OBSERVATIONS_PER_PAIR=50, SEED_WEIGHT=6, etc.",
      "IMPL: Remove CONF_LINKED_ZONES and related constants",
      "VERIFY: pytest tests/ -v --tb=short passes"
    ],
    "passes": true,
    "commitId": "f2bff19"
  },
  {
    "id": "1.2",
    "category": "infrastructure",
    "description": "Create CouplingObservation dataclass with serialization",
    "steps": [
      "TEST: test_coupling_observation_creation - create observation with all fields",
      "IMPL: Create adaptive/thermal_coupling.py with CouplingObservation dataclass",
      "TEST: test_coupling_observation_to_dict - serializes datetime as ISO string",
      "IMPL: Add to_dict() method to CouplingObservation",
      "TEST: test_coupling_observation_from_dict - deserializes from dict",
      "IMPL: Add @classmethod from_dict() to CouplingObservation",
      "VERIFY: pytest tests/test_thermal_coupling.py -k observation -v passes"
    ],
    "passes": true,
    "commitId": "b51a214"
  },
  {
    "id": "1.3",
    "category": "infrastructure",
    "description": "Create CouplingCoefficient dataclass with serialization",
    "steps": [
      "TEST: test_coupling_coefficient_creation - create with all fields including baseline_overshoot",
      "IMPL: Add CouplingCoefficient dataclass to thermal_coupling.py",
      "TEST: test_coupling_coefficient_to_dict - serializes correctly",
      "IMPL: Add to_dict() method",
      "TEST: test_coupling_coefficient_from_dict - deserializes correctly",
      "IMPL: Add @classmethod from_dict()",
      "VERIFY: pytest tests/test_thermal_coupling.py -k coefficient -v passes"
    ],
    "passes": true,
    "commitId": "6170892"
  },
  {
    "id": "1.4",
    "category": "infrastructure",
    "description": "Create ObservationContext dataclass",
    "steps": [
      "TEST: test_observation_context_creation - tracks source zone and start temps",
      "IMPL: Add ObservationContext dataclass with source_zone, start_time, source_temp_start, target_temps_start, outdoor_temp_start",
      "VERIFY: pytest tests/test_thermal_coupling.py -k context -v passes"
    ],
    "passes": true,
    "commitId": "9900192"
  },
  {
    "id": "2.1",
    "category": "infrastructure",
    "description": "Implement floorplan parser for seed generation",
    "steps": [
      "TEST: test_parse_floorplan_same_floor - zones on same floor get same_floor seed",
      "IMPL: Add parse_floorplan(config) function that extracts zone pairs and directions",
      "TEST: test_parse_floorplan_vertical - floor N to N+1 gets 'up' seed, N to N-1 gets 'down'",
      "IMPL: Add logic to detect vertical relationships between floors",
      "TEST: test_parse_floorplan_open - zones listed in 'open' array get open seed",
      "IMPL: Add open floor plan detection",
      "TEST: test_parse_floorplan_stairwell - stairwell_zones get stairwell_up/down seeds",
      "IMPL: Add stairwell zone handling",
      "TEST: test_parse_floorplan_custom_seeds - override default seed values from config",
      "IMPL: Add seed_coefficients config merge with defaults",
      "VERIFY: pytest tests/test_thermal_coupling.py -k floorplan -v passes"
    ],
    "passes": true,
    "commitId": "7d2636b"
  },
  {
    "id": "2.2",
    "category": "infrastructure",
    "description": "Implement ThermalCouplingLearner core structure",
    "steps": [
      "TEST: test_learner_initialization - creates empty observations/coefficients dicts",
      "IMPL: Create ThermalCouplingLearner class with __init__, asyncio.Lock",
      "TEST: test_learner_seed_initialization - loads seeds from floorplan",
      "IMPL: Add initialize_seeds(floorplan_config) method",
      "TEST: test_learner_get_coefficient_no_data - returns None for unknown pair",
      "IMPL: Add get_coefficient(source, target) method",
      "TEST: test_learner_get_coefficient_seed_only - returns seed with 0.3 confidence",
      "IMPL: Add seed fallback in get_coefficient",
      "VERIFY: pytest tests/test_thermal_coupling.py -k learner -v passes"
    ],
    "passes": true,
    "commitId": "f4903be"
  },
  {
    "id": "2.3",
    "category": "infrastructure",
    "description": "Implement observation start/end lifecycle",
    "steps": [
      "TEST: test_start_observation - creates ObservationContext for source zone",
      "IMPL: Add start_observation(source_zone, all_zone_temps, outdoor_temp) method",
      "TEST: test_start_observation_skips_if_pending - no duplicate observations for same source",
      "IMPL: Add guard clause checking _pending dict",
      "TEST: test_end_observation_creates_records - creates CouplingObservation for each idle zone",
      "IMPL: Add end_observation(source_zone, current_temps, outdoor_temp) method",
      "TEST: test_end_observation_calculates_deltas - computes source_temp_delta and target_temp_delta",
      "IMPL: Add delta calculation logic",
      "VERIFY: pytest tests/test_thermal_coupling.py -k 'start_obs or end_obs' -v passes"
    ],
    "passes": true,
    "commitId": "0e7b598"
  },
  {
    "id": "2.4",
    "category": "infrastructure",
    "description": "Implement observation filtering logic",
    "steps": [
      "TEST: test_filter_skip_short_duration - skips observations < 15 min",
      "IMPL: Add _should_record_observation() with duration check",
      "TEST: test_filter_skip_low_source_rise - skips if source temp rise < 0.3C",
      "IMPL: Add source temp rise filter",
      "TEST: test_filter_skip_target_warmer - skips if target was warmer than source",
      "IMPL: Add target-warmer-than-source filter",
      "TEST: test_filter_skip_outdoor_change - skips if outdoor temp changed > 3C",
      "IMPL: Add outdoor temp stability filter",
      "TEST: test_filter_skip_target_dropped - skips if target temp dropped",
      "IMPL: Add target temp drop filter",
      "VERIFY: pytest tests/test_thermal_coupling.py -k filter -v passes"
    ],
    "passes": true,
    "commitId": "02d9e8f"
  },
  {
    "id": "2.5",
    "category": "infrastructure",
    "description": "Implement Bayesian coefficient calculation",
    "steps": [
      "TEST: test_calc_transfer_rate - computes target_delta / (source_delta * hours)",
      "IMPL: Add _calculate_transfer_rate(observation) method",
      "TEST: test_calc_coefficient_no_seed - pure average of transfer rates",
      "IMPL: Add calculate_coefficient(source, target) method without seed",
      "TEST: test_calc_coefficient_with_seed - Bayesian blend: (seed*6 + obs*count) / (6+count)",
      "IMPL: Add Bayesian blending with SEED_WEIGHT=6",
      "TEST: test_calc_confidence - base_confidence from count, reduced by variance",
      "IMPL: Add confidence calculation with variance penalty",
      "TEST: test_coefficient_capped - coefficient capped at MAX_COEFFICIENT=0.5",
      "IMPL: Add coefficient capping",
      "VERIFY: pytest tests/test_thermal_coupling.py -k 'calc_coef or transfer_rate' -v passes"
    ],
    "passes": true,
    "commitId": "7f63a23"
  },
  {
    "id": "2.6",
    "category": "infrastructure",
    "description": "Implement graduated confidence function",
    "steps": [
      "TEST: test_graduated_confidence_below_threshold - returns 0 if confidence < 0.3",
      "IMPL: Add graduated_confidence(confidence) function",
      "TEST: test_graduated_confidence_above_max - returns 1.0 if confidence >= 0.5",
      "IMPL: Add upper bound check",
      "TEST: test_graduated_confidence_linear_ramp - linear interpolation between 0.3 and 0.5",
      "IMPL: Add linear ramp formula",
      "VERIFY: pytest tests/test_thermal_coupling.py -k graduated -v passes"
    ],
    "passes": true,
    "commitId": "d2af39e"
  },
  {
    "id": "2.7",
    "category": "infrastructure",
    "description": "Implement learner serialization for persistence",
    "steps": [
      "TEST: test_learner_to_dict - serializes observations and coefficients",
      "IMPL: Add to_dict() method to ThermalCouplingLearner",
      "TEST: test_learner_from_dict - restores learner state from dict",
      "IMPL: Add @classmethod from_dict() with error recovery per item",
      "TEST: test_learner_roundtrip - to_dict then from_dict preserves state",
      "IMPL: Verify roundtrip in test",
      "VERIFY: pytest tests/test_thermal_coupling.py -k 'to_dict or from_dict' -v passes"
    ],
    "passes": true,
    "commitId": "f1ee4ac"
  },
  {
    "id": "3.1",
    "category": "infrastructure",
    "description": "Add v3 to v4 migration in persistence.py",
    "steps": [
      "TEST: test_migrate_v3_to_v4 - adds thermal_coupling key with empty dicts",
      "IMPL: Add _migrate_v3_to_v4() method to LearningDataStore",
      "TEST: test_load_v3_auto_migrates - loading v3 data returns v4 format",
      "IMPL: Add migration call in async_load() version check",
      "VERIFY: pytest tests/test_persistence.py -k migrate -v passes"
    ],
    "passes": true,
    "commitId": "6e1f512"
  },
  {
    "id": "3.2",
    "category": "infrastructure",
    "description": "Add coupling data storage methods to persistence.py",
    "steps": [
      "TEST: test_get_coupling_data_empty - returns None when no coupling data",
      "IMPL: Add get_coupling_data() method",
      "TEST: test_update_coupling_data - stores coupling learner dict",
      "IMPL: Add update_coupling_data(data) method",
      "TEST: test_save_coupling_data - persists to HA Store",
      "IMPL: Add async_save_coupling() method",
      "TEST: test_coupling_data_roundtrip - save then load preserves data",
      "IMPL: Verify roundtrip in integration test",
      "VERIFY: pytest tests/test_learning_storage.py -k coupling -v passes"
    ],
    "passes": true,
    "commitId": "ec0894d"
  },
  {
    "id": "4.1",
    "category": "feature",
    "description": "Add feedforward term to PID controller",
    "steps": [
      "TEST: test_pid_feedforward_init - feedforward defaults to 0",
      "IMPL: Add _feedforward = 0 to PIDController.__init__",
      "TEST: test_pid_set_feedforward - set_feedforward updates internal value",
      "IMPL: Add set_feedforward(ff) method",
      "TEST: test_pid_output_includes_feedforward - output = P + I + D + E - F",
      "IMPL: Subtract feedforward in calc() output",
      "TEST: test_pid_antiwindup_accounts_for_feedforward - I_max = out_max - E - F",
      "IMPL: Update integral clamping formula",
      "VERIFY: pytest tests/test_pid_controller.py -k feedforward -v passes"
    ],
    "passes": true,
    "commitId": "15e8b1e"
  },
  {
    "id": "5.1",
    "category": "refactor",
    "description": "Remove ZoneLinker from coordinator.py",
    "steps": [
      "IMPL: Delete ZoneLinker class from coordinator.py",
      "IMPL: Remove zone_linker references from AdaptiveThermostatCoordinator",
      "IMPL: Remove linked_zones handling from register_zone()",
      "IMPL: Delete tests/test_zone_linking.py",
      "VERIFY: pytest tests/ -v --tb=short passes (expect some failures until integration complete)"
    ],
    "passes": true,
    "commitId": "8df27ae"
  },
  {
    "id": "5.2",
    "category": "feature",
    "description": "Integrate ThermalCouplingLearner into coordinator",
    "steps": [
      "TEST: test_coordinator_has_coupling_learner - learner accessible via coordinator",
      "IMPL: Add _thermal_coupling_learner to AdaptiveThermostatCoordinator.__init__",
      "TEST: test_coordinator_outdoor_temp_access - coordinator provides outdoor temp",
      "IMPL: Add outdoor_temp property to coordinator (from weather_entity)",
      "TEST: test_coordinator_get_active_zones - returns zones with has_demand=True",
      "IMPL: Add get_active_zones() method returning dict of demanding zones",
      "TEST: test_coordinator_zone_temps - provides current temp per zone",
      "IMPL: Add get_zone_temps() method",
      "VERIFY: pytest tests/test_coordinator.py -k coupling -v passes"
    ],
    "passes": true,
    "commitId": "e6ef8c1"
  },
  {
    "id": "5.3",
    "category": "feature",
    "description": "Add observation triggers to coordinator demand updates",
    "steps": [
      "TEST: test_demand_true_starts_observation - demand=True after 5min starts observation",
      "IMPL: Add observation start logic to update_zone_demand() on demand transition",
      "TEST: test_demand_false_ends_observation - demand=False ends observation and records",
      "IMPL: Add observation end logic to update_zone_demand()",
      "TEST: test_mass_recovery_skips_observation - >50% zones demanding skips observation",
      "IMPL: Add mass recovery detection in observation start",
      "VERIFY: pytest tests/test_coordinator.py -k observation -v passes"
    ],
    "passes": true,
    "commitId": "a587c36"
  },
  {
    "id": "5.4",
    "category": "feature",
    "description": "Add solar gain detection for observation filtering",
    "steps": [
      "TEST: test_solar_gain_detection - detects high solar based on sun elevation and window",
      "IMPL: Add _is_high_solar_gain() method using SunPositionCalculator",
      "TEST: test_observation_skipped_during_solar - observation skipped when solar detected",
      "IMPL: Integrate solar check into observation start logic",
      "VERIFY: pytest tests/test_coordinator.py -k solar -v passes"
    ],
    "passes": true,
    "commitId": ""
  },
  {
    "id": "6.1",
    "category": "feature",
    "description": "Calculate coupling compensation in ControlOutputManager",
    "steps": [
      "TEST: test_coupling_compensation_single_neighbor - calculates compensation from one heating neighbor",
      "IMPL: Add _calculate_coupling_compensation() method to ControlOutputManager",
      "TEST: test_coupling_compensation_multiple_neighbors - sums compensation from multiple sources",
      "IMPL: Add loop over active zones in compensation calculation",
      "TEST: test_coupling_compensation_capped - capped at MAX_COMPENSATION for heating type",
      "IMPL: Add cap based on heating_type",
      "TEST: test_coupling_compensation_converts_to_power - uses Kp to convert degC to power%",
      "IMPL: Add power conversion: compensation_power = compensation_degC * kp",
      "TEST: test_coupling_compensation_disabled_cooling - returns 0 when hvac_mode is cool",
      "IMPL: Add cooling mode check",
      "VERIFY: pytest tests/test_control_output.py -k coupling -v passes"
    ],
    "passes": false
  },
  {
    "id": "6.2",
    "category": "feature",
    "description": "Pass feedforward to PID in control loop",
    "steps": [
      "TEST: test_control_loop_sets_feedforward - PID receives coupling compensation as feedforward",
      "IMPL: Call pid.set_feedforward(compensation_power) before calc_output()",
      "TEST: test_control_loop_reduces_output - output reduced when neighbors heating",
      "IMPL: Verify in integration test that output decreases",
      "VERIFY: pytest tests/test_control_output.py -k feedforward -v passes"
    ],
    "passes": false
  },
  {
    "id": "7.1",
    "category": "feature",
    "description": "Add thermal coupling config parsing to climate.py",
    "steps": [
      "TEST: test_config_thermal_coupling_enabled - parses enabled flag (default true)",
      "IMPL: Add CONF_THERMAL_COUPLING to PLATFORM_SCHEMA",
      "TEST: test_config_floorplan_parsed - parses floorplan with floors and zones",
      "IMPL: Add floorplan schema validation",
      "TEST: test_config_stairwell_zones_parsed - parses stairwell_zones list",
      "IMPL: Add stairwell_zones to schema",
      "TEST: test_config_seed_coefficients_override - custom seeds override defaults",
      "IMPL: Add seed_coefficients to schema with defaults",
      "VERIFY: pytest tests/test_climate.py -k config -v passes"
    ],
    "passes": false
  },
  {
    "id": "7.2",
    "category": "feature",
    "description": "Initialize coupling learner in climate entity setup",
    "steps": [
      "TEST: test_climate_init_coupling_learner - learner created during setup",
      "IMPL: Create ThermalCouplingLearner in async_setup_platform",
      "TEST: test_climate_restore_coupling_data - restores from persistence on startup",
      "IMPL: Call learner.from_dict() with persisted data",
      "TEST: test_climate_seeds_from_floorplan - seeds initialized from config",
      "IMPL: Call learner.initialize_seeds() with floorplan config",
      "VERIFY: pytest tests/test_climate.py -k coupling_init -v passes"
    ],
    "passes": false
  },
  {
    "id": "7.3",
    "category": "feature",
    "description": "Expose coupling attributes on climate entity",
    "steps": [
      "TEST: test_attr_coupling_coefficients - returns dict of zone coefficients",
      "IMPL: Add coupling_coefficients to extra_state_attributes",
      "TEST: test_attr_coupling_compensation - returns current degC compensation",
      "IMPL: Add coupling_compensation attribute",
      "TEST: test_attr_coupling_compensation_power - returns current power% reduction",
      "IMPL: Add coupling_compensation_power attribute",
      "TEST: test_attr_coupling_observations_pending - returns count of active observations",
      "IMPL: Add coupling_observations_pending attribute",
      "TEST: test_attr_coupling_learner_state - returns learning/validating/stable",
      "IMPL: Add coupling_learner_state attribute",
      "VERIFY: pytest tests/test_climate.py -k attr_coupling -v passes"
    ],
    "passes": false
  },
  {
    "id": "7.4",
    "category": "refactor",
    "description": "Remove linked_zones config from climate.py",
    "steps": [
      "IMPL: Remove CONF_LINKED_ZONES from PLATFORM_SCHEMA",
      "IMPL: Remove linked_zones handling from async_setup_platform",
      "IMPL: Remove zone_link_delayed and zone_link_delay_remaining attributes",
      "VERIFY: pytest tests/test_climate.py -v passes"
    ],
    "passes": false
  },
  {
    "id": "8.1",
    "category": "feature",
    "description": "Implement validation and rollback for coefficients",
    "steps": [
      "TEST: test_validation_tracks_baseline - stores baseline_overshoot before compensation",
      "IMPL: Add baseline tracking in CouplingCoefficient when compensation first applied",
      "TEST: test_validation_counts_cycles - increments validation_cycles after coefficient change",
      "IMPL: Add cycle counting in learner",
      "TEST: test_validation_rollback_triggered - coefficient halved if overshoot increased >30%",
      "IMPL: Add check_validation() method that compares overshoot to baseline",
      "TEST: test_validation_rollback_logs_warning - logs warning when rollback occurs",
      "IMPL: Add logging in rollback logic",
      "VERIFY: pytest tests/test_thermal_coupling.py -k validation -v passes"
    ],
    "passes": false
  },
  {
    "id": "9.1",
    "category": "test",
    "description": "Create integration tests for coupling learning flow",
    "steps": [
      "TEST: test_integration_zone_heats_observation_started - Zone A heating starts observation",
      "IMPL: Create test_coupling_integration.py with multi-zone fixture",
      "TEST: test_integration_observation_recorded - observation stored after Zone A stops heating",
      "IMPL: Simulate full heating cycle in test",
      "TEST: test_integration_coefficient_calculated - coefficient available after MIN_OBSERVATIONS",
      "IMPL: Simulate 3 cycles and verify coefficient",
      "TEST: test_integration_compensation_applied - Zone B output reduced when Zone A heating",
      "IMPL: Verify feedforward applied in control loop",
      "TEST: test_integration_persistence_roundtrip - learner state survives restart",
      "IMPL: Save, reload, verify state preserved",
      "VERIFY: pytest tests/test_coupling_integration.py -v passes"
    ],
    "passes": false
  },
  {
    "id": "10.1",
    "category": "refactor",
    "description": "Remove ZoneLinker from heater_controller.py",
    "steps": [
      "IMPL: Remove any ZoneLinker calls from HeaterController",
      "IMPL: Remove zone_link_check() or similar methods if present",
      "VERIFY: pytest tests/test_heater_controller.py -v passes"
    ],
    "passes": false
  },
  {
    "id": "11.1",
    "category": "docs",
    "description": "Update CLAUDE.md with thermal coupling documentation",
    "steps": [
      "IMPL: Add Thermal Coupling section to CLAUDE.md architecture table",
      "IMPL: Document floorplan config format with examples",
      "IMPL: Document seed coefficients and their meanings",
      "IMPL: Add entity attributes documentation",
      "IMPL: Add data flow diagram for coupling compensation",
      "VERIFY: Review CLAUDE.md for completeness"
    ],
    "passes": false
  },
  {
    "id": "12.1",
    "category": "test",
    "description": "Final verification - full test suite",
    "steps": [
      "VERIFY: pytest tests/ -v --tb=short passes all tests",
      "VERIFY: No regressions in existing functionality",
      "VERIFY: Coverage maintained or improved"
    ],
    "passes": false
  }
]
